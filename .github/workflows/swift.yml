name: Xcode Build & Test (fixed)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show repo (debug)
        run: |
          pwd
          ls -la
          echo "=== find workspaces & projects ==="
          find . -maxdepth 3 -type f -name '*.xcworkspace' -print || true
          find . -maxdepth 3 -type d -name '*.xcodeproj' -print || true

      - name: Determine build target and scheme
        id: detect
        run: |
          set -euo pipefail

          WORKSPACE=$(find . -maxdepth 3 -name '*.xcworkspace' | head -n 1 || true)
          PROJECT=$(find . -maxdepth 3 -name '*.xcodeproj' | head -n 1 || true)

          if [ -n "$WORKSPACE" ]; then
            echo "Detected workspace: $WORKSPACE"
            TARGET_TYPE="workspace"
            TARGET_PATH="$WORKSPACE"
            SCHEMES=$(xcodebuild -workspace "$WORKSPACE" -list 2>/dev/null || true)
          elif [ -n "$PROJECT" ]; then
            echo "Detected project: $PROJECT"
            TARGET_TYPE="project"
            TARGET_PATH="$PROJECT"
            SCHEMES=$(xcodebuild -project "$PROJECT" -list 2>/dev/null || true)
          else
            echo "::error::No .xcworkspace or .xcodeproj found. Exiting."
            exit 1
          fi

          # Try to parse first scheme name from xcodebuild -list output
          # We look for the "Schemes:" section and grab the first non-empty line after it.
          SCHEME=$(echo "$SCHEMES" | awk '/Schemes:/{p=1; next} p && NF{print $1; exit}')

          if [ -z "$SCHEME" ]; then
            echo "::error::Could not auto-detect a scheme. Ensure the scheme is Shared (Xcode -> Manage Schemes -> Shared)."
            exit 1
          fi

          # Use the GITHUB_OUTPUT env file to set action outputs (preferred to deprecated set-output)
          echo "target_type=$TARGET_TYPE" >> $GITHUB_OUTPUT
          echo "target_path=$TARGET_PATH" >> $GITHUB_OUTPUT
          echo "scheme=$SCHEME" >> $GITHUB_OUTPUT

      - name: Build & Test (xcodebuild)
        run: |
          set -euo pipefail

          TARGET_TYPE="${{ steps.detect.outputs.target_type }}"
          TARGET_PATH="${{ steps.detect.outputs.target_path }}"
          SCHEME="${{ steps.detect.outputs.scheme }}"

          echo "Using target type: $TARGET_TYPE"
          echo "Using target path: $TARGET_PATH"
          echo "Using scheme: $SCHEME"

          DESTINATION='platform=iOS Simulator,name=iPhone 17'

          if [ "$TARGET_TYPE" = "workspace" ]; then
            xcodebuild -workspace "$TARGET_PATH" -scheme "$SCHEME" -destination "$DESTINATION" clean test | xcpretty || true
          else
            xcodebuild -project "$TARGET_PATH" -scheme "$SCHEME" -destination "$DESTINATION" clean test | xcpretty || true
          fi
        env:
          CI: true

      - name: Upload test results (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xcode-tests-results
          path: |
            ~/Library/Logs/DiagnosticReports
            DerivedData
